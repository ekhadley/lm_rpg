<!DOCTYPE html>
<html lang="en" data-theme="discord">
<head>
    <script>
        // Load theme immediately to prevent flash
        (function() {
            const savedTheme = localStorage.getItem('theme');
            if (savedTheme) {
                document.documentElement.setAttribute('data-theme', savedTheme);
            }
        })();
        // Initial story from URL (if any)
        window.INITIAL_STORY = {{ selected_story | tojson | safe if selected_story else 'null' }};
    </script>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="{{ url_for('static', filename='styles.css') }}">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=EB+Garamond:wght@400;500;600&display=swap">
</head>
<body>
    <div class="main-container">
        <!-- Sidebar with story list -->
        <div class="sidebar">
            <div class="sidebar-header">
                <h5 class="sidebar-title">Stories</h5>
                <button class="new-story-btn" id="new-story-btn">
                    <i class="fas fa-plus"></i>
                </button>
            </div>
            <ul class="story-list" id="story-list">
                {% for story in stories %}
                <li class="story-item {% if session.get('story') == story.name %}active{% endif %}" data-story="{{ story.name }}">
                    {% if story.system == 'hp' %}<span class="hp-logo-icon" title="{{ story.system }}"></span>{% else %}<i class="{% if story.system == 'dnd5e' %}fab fa-d-and-d{% else %}fas fa-scroll{% endif %}" title="{{ story.system }}"></i>{% endif %}
                    <div class="story-item-content">
                        <div class="story-name-row">
                            <span class="story-name">{{ story.name }}</span>
                        </div>
                        <span class="story-meta">{{ story.model }}</span>
                    </div>
                    <button class="story-menu-btn" data-story="{{ story.name }}" title="Story options">
                        <i class="fas fa-ellipsis-v"></i>
                    </button>
                    <div class="story-context-menu" data-story="{{ story.name }}">
                        <div class="context-menu-item" data-action="copy-story">
                            <i class="fas fa-copy"></i>
                            <span>Copy Story</span>
                        </div>
                        <div class="context-menu-item delete" data-action="delete-story">
                            <i class="fas fa-trash"></i>
                            <span>Delete Story</span>
                        </div>
                    </div>
                </li>
                {% endfor %}
            </ul>
            <div class="sidebar-footer">
                <button class="theme-toggle-btn" id="theme-toggle-btn" title="Change theme">
                    <i class="fas fa-palette"></i>
                </button>
                <div class="theme-picker" id="theme-picker">
                    <div class="theme-picker-grid">
                        <button class="theme-option" data-theme="discord">
                            <div class="theme-swatch" style="background: linear-gradient(135deg, #2b2d31 50%, #5865f2 50%)"></div>
                            <span>Discord</span>
                        </button>
                        <button class="theme-option" data-theme="green-lamp">
                            <div class="theme-swatch" style="background: linear-gradient(135deg, #0f1a14 50%, #b8a44c 50%)"></div>
                            <span>Green Lamp</span>
                        </button>
                        <button class="theme-option" data-theme="gruvbox-dark">
                            <div class="theme-swatch" style="background: linear-gradient(135deg, #2c2c2c 50%, #83a598 50%)"></div>
                            <span>Gruvbox</span>
                        </button>
                        <button class="theme-option" data-theme="leather-gilt">
                            <div class="theme-swatch" style="background: linear-gradient(135deg, #1f1812 50%, #c9a84c 50%)"></div>
                            <span>Leather & Gilt</span>
                        </button>
                        <button class="theme-option" data-theme="parchment">
                            <div class="theme-swatch" style="background: linear-gradient(135deg, #ede4d3 50%, #8b2d2d 50%)"></div>
                            <span>Parchment</span>
                        </button>
                        <button class="theme-option" data-theme="study">
                            <div class="theme-swatch" style="background: linear-gradient(135deg, #e4e8ec 50%, #2e6e4e 50%)"></div>
                            <span>Study</span>
                        </button>
                        <button class="theme-option" data-theme="tavern">
                            <div class="theme-swatch" style="background: linear-gradient(135deg, #1b1511 50%, #d4a24c 50%)"></div>
                            <span>Tavern</span>
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Main chat area -->
        <div class="chat-wrapper">
            <div class="chat-header" id="chat-header" style="display: none;">
                <div class="story-header-content">
                    <div class="story-title-row">
                        <i id="current-story-icon" class="story-header-icon" style="display: none;"></i>
                        <h5 id="current-story-title"></h5>
                    </div>
                    <div id="current-story-model" class="story-model-subtext" style="display: none;"></div>
                </div>
                <button id="export-button" class="header-button export-button" title="Export conversation to console">
                    <i class="fas fa-code"></i>
                </button>
            </div>
            <div class="chat-container">
                <div id="chat-history" class="chat-history">
                    <!-- Messages will appear here -->
                </div>

                <div class="input-area">
                    <form id="message-form">
                        <input 
                            type="text" 
                            id="user-input" 
                            class="form-control" 
                            placeholder="" 
                            autocomplete="off"
                        >
                    </form>
                </div>
            </div>
            <div class="welcome-container" id="welcome-container">
                <p>Select an existing story from the sidebar or create a new one to begin your adventure.</p>
                <i class="fas fa-dice-d20 fa-3x" style="color: var(--accent); opacity: 0.8; margin-bottom: 20px;"></i>
            </div>

            <!-- Floating corner buttons -->
            <button id="archive-button" class="floating-button left" title="Archive current conversation">
                <i class="fas fa-archive"></i>
            </button>
            <div class="floating-cost-container">
                <button id="cost-button" class="floating-button right" title="Cost information">
                    <i class="fas fa-sack-dollar"></i>
                </button>
                <div id="cost-popup" class="cost-popup">
                    <div class="cost-popup-header">
                        <i class="fas fa-sack-dollar"></i>
                        <span>Usage & Cost</span>
                    </div>
                    <div class="cost-popup-body">
                        <div class="cost-stat">
                            <span class="cost-label">Total Tokens</span>
                            <span class="cost-value" id="cost-total-tokens">0</span>
                        </div>
                        <div class="cost-stat">
                            <span class="cost-label">Avg Tokens/Turn</span>
                            <span class="cost-value" id="cost-avg-tokens">0</span>
                        </div>
                        <div class="cost-stat">
                            <span class="cost-label">Total Cost</span>
                            <span class="cost-value" id="cost-total-cost">$0.00</span>
                        </div>
                        <div class="cost-stat">
                            <span class="cost-label">Avg Cost/Turn</span>
                            <span class="cost-value" id="cost-avg-cost">$0.00</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Right sidebar: story files -->
        <div class="right-sidebar" id="right-sidebar">
            <div class="right-sidebar-resize" id="right-sidebar-resize"></div>
            <div class="sidebar-header">
                <h5 class="sidebar-title">Story Files</h5>
            </div>
            <ul class="file-list" id="file-list"></ul>
        </div>
    </div>

    <!-- Create Story Modal -->
    <div id="create-story-modal" class="modal-overlay">
        <div class="modal-content">
            <div class="modal-header">
                <h5>Create New Story</h5>
                <button class="modal-close" id="create-story-modal-close">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label for="new_story_name">Story Name</label>
                    <input 
                        type="text" 
                        id="new_story_name" 
                        class="form-control" 
                        placeholder="Enter story name"
                        required
                    >
                </div>
                <div class="form-group">
                    <label class="select-label">System</label>
                    <div class="custom-select-wrapper">
                        <div class="custom-select" id="create-system-select-custom" tabindex="0">
                            <span class="custom-select-value">hp</span>
                            <i class="fas fa-chevron-down custom-select-arrow"></i>
                        </div>
                        <select id="create-system-select" class="system-select" style="display: none;">
                            {% for system in systems %}
                            <option value="{{ system }}" {% if system == 'hp' %}selected{% endif %}>{{ system }}</option>
                            {% endfor %}
                        </select>
                        <div class="custom-select-dropdown" id="create-system-select-dropdown">
                            {% for system in systems %}
                            <div class="custom-select-option" data-value="{{ system }}" {% if system == 'hp' %}data-selected="true"{% endif %}>{{ system }}</div>
                            {% endfor %}
                        </div>
                    </div>
                </div>
                <div class="form-group">
                    <label class="select-label">Model</label>
                    <div class="custom-select-wrapper">
                        <div class="custom-select" id="create-model-select-custom" tabindex="0">
                            <span class="custom-select-value">openai/gpt-5.2</span>
                            <i class="fas fa-chevron-down custom-select-arrow"></i>
                        </div>
                        <select id="create-model-select" class="model-select" style="display: none;">
                            {% for model in models %}
                            <option value="{{ model }}" {% if model == 'openai/gpt-5' %}selected{% endif %}>{{ model }}</option>
                            {% endfor %}
                        </select>
                        <div class="custom-select-dropdown" id="create-model-select-dropdown">
                            {% for model in models %}
                            <div class="custom-select-option" data-value="{{ model }}" {% if model == 'openai/gpt-5.2' %}data-selected="true"{% endif %}>{{ model }}</div>
                            {% endfor %}
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" id="create-story-modal-cancel">Cancel</button>
                <button class="btn btn-primary" id="create-story-btn">Create</button>
            </div>
        </div>
    </div>

    <!-- Archive Confirmation Popup -->
    <div id="archive-popup" class="archive-popup">
        <div class="archive-popup-header">
            <i class="fas fa-exclamation-triangle"></i>
            <span>Archive Conversation</span>
        </div>
        <div class="archive-popup-body">
            <p>Archive current conversation? This will start a fresh conversation.</p>
        </div>
        <div class="archive-popup-footer">
            <button class="archive-popup-btn archive-popup-btn-cancel" id="archive-popup-cancel">Cancel</button>
            <button class="archive-popup-btn archive-popup-btn-confirm" id="archive-popup-confirm">Archive</button>
        </div>
    </div>

    <!-- Confirm Popup (custom replacement for browser confirm()) -->
    <div id="confirm-popup-overlay" class="modal-overlay">
        <div class="confirm-popup-content">
            <div class="confirm-popup-body">
                <p id="confirm-popup-message"></p>
            </div>
            <div class="confirm-popup-footer">
                <button class="btn btn-secondary" id="confirm-popup-cancel">Cancel</button>
                <button class="btn btn-primary" id="confirm-popup-confirm">Confirm</button>
            </div>
        </div>
    </div>

    <!-- Select Story System/Model Modal -->
    <div id="select-story-config-modal" class="modal-overlay">
        <div class="modal-content">
            <div class="modal-header">
                <h5>Configure Story</h5>
                <button class="modal-close" id="select-story-config-modal-close">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body">
                <p style="margin-bottom: 20px; color: var(--text-normal);">This story needs a system and model to be configured.</p>
                <div class="form-group">
                    <label class="select-label">System</label>
                    <div class="custom-select-wrapper">
                        <div class="custom-select" id="select-story-system-select-custom" tabindex="0">
                            <span class="custom-select-value">hp</span>
                            <i class="fas fa-chevron-down custom-select-arrow"></i>
                        </div>
                        <select id="select-story-system-select" class="system-select" style="display: none;">
                            {% for system in systems %}
                            <option value="{{ system }}" {% if system == 'hp' %}selected{% endif %}>{{ system }}</option>
                            {% endfor %}
                        </select>
                        <div class="custom-select-dropdown" id="select-story-system-select-dropdown">
                            {% for system in systems %}
                            <div class="custom-select-option" data-value="{{ system }}" {% if system == 'hp' %}data-selected="true"{% endif %}>{{ system }}</div>
                            {% endfor %}
                        </div>
                    </div>
                </div>
                <div class="form-group">
                    <label class="select-label">Model</label>
                    <div class="custom-select-wrapper">
                        <div class="custom-select" id="select-story-model-select-custom" tabindex="0">
                            <span class="custom-select-value">openai/gpt-5.2</span>
                            <i class="fas fa-chevron-down custom-select-arrow"></i>
                        </div>
                        <select id="select-story-model-select" class="model-select" style="display: none;">
                            {% for model in models %}
                            <option value="{{ model }}" {% if model == 'openai/gpt-5.2' %}selected{% endif %}>{{ model }}</option>
                            {% endfor %}
                        </select>
                        <div class="custom-select-dropdown" id="select-story-model-select-dropdown">
                            {% for model in models %}
                            <div class="custom-select-option" data-value="{{ model }}" {% if model == 'openai/gpt-5.2' %}data-selected="true"{% endif %}>{{ model }}</div>
                            {% endfor %}
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" id="select-story-config-modal-cancel">Cancel</button>
                <button class="btn btn-primary" id="select-story-config-btn">Continue</button>
            </div>
        </div>
    </div>

    <!-- Copy Story Modal -->
    <div id="copy-story-modal" class="modal-overlay">
        <div class="modal-content">
            <div class="modal-header">
                <h5>Copy Story</h5>
                <button class="modal-close" id="copy-story-modal-close">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label for="copy_story_name">New Story Name</label>
                    <input 
                        type="text" 
                        id="copy_story_name" 
                        class="form-control" 
                        placeholder="Enter new story name"
                        required
                    >
                </div>
                <div class="form-group">
                    <label class="select-label">Model</label>
                    <div class="custom-select-wrapper">
                        <div class="custom-select" id="copy-story-model-select-custom" tabindex="0">
                            <span class="custom-select-value">openai/gpt-5.2</span>
                            <i class="fas fa-chevron-down custom-select-arrow"></i>
                        </div>
                        <select id="copy-story-model-select" class="model-select" style="display: none;">
                            {% for model in models %}
                            <option value="{{ model }}" {% if model == 'openai/gpt-5.2' %}selected{% endif %}>{{ model }}</option>
                            {% endfor %}
                        </select>
                        <div class="custom-select-dropdown" id="copy-story-model-select-dropdown">
                            {% for model in models %}
                            <div class="custom-select-option" data-value="{{ model }}" {% if model == 'openai/gpt-5.2' %}data-selected="true"{% endif %}>{{ model }}</div>
                            {% endfor %}
                        </div>
                    </div>
                </div>
                <div class="form-group">
                    <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                        <input type="checkbox" id="copy_all_history" style="width: auto; margin: 0;">
                        <span>Copy all history files (including archived conversations)</span>
                    </label>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" id="copy-story-modal-cancel">Cancel</button>
                <button class="btn btn-primary" id="copy-story-btn">Copy</button>
            </div>
        </div>
    </div>

    <!-- Debug Messages Modal -->
    <div id="debug-modal" class="modal-overlay">
        <div class="debug-modal-content">
            <div class="debug-modal-header">
                <h5><i class="fas fa-code"></i> Conversation Debug</h5>
                <button class="modal-close" id="debug-modal-close">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="debug-modal-body" id="debug-modal-body">
            </div>
        </div>
    </div>

    <!-- File Viewer Overlay -->
    <div id="file-viewer-overlay" class="modal-overlay">
        <div class="file-viewer-content">
            <div class="file-viewer-header">
                <h5 id="file-viewer-title"></h5>
                <button class="modal-close" id="file-viewer-close">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="file-viewer-main">
                <nav class="file-viewer-toc" id="file-viewer-toc"></nav>
                <div class="file-viewer-body" id="file-viewer-body"></div>
            </div>
        </div>
    </div>

    <script src="https://cdn.socket.io/4.6.0/socket.io.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script type="module" src="{{ url_for('static', filename='main.js') }}"></script>
</body>
</html>
